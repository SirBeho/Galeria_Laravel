name: Deploy Produccion Optimizada

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define la URL de producci√≥n como una variable de entorno para el Job
    env:
      APP_URL_PROD: xn--mundodelcumpleao-lub.com
      DEPLOY_CLEAN_TOKEN: ${{ secrets.DEPLOY_CLEAN_TOKEN }}

    steps:
    - name: Checkout C√≥digo Fuente
      uses: actions/checkout@v4

    # -----------------------------------------------
    # 1. PREPARACI√ìN DEL BACKEND (con Caching Condicional)
    # -----------------------------------------------
    - name: Configurar PHP (8.2)
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Aseg√∫rate que esta es la versi√≥n de tu hosting
        extensions: pdo_mysql, dom, curl, mbstring, zip # 'zip' es vital para el vendor.zip
        tools: composer
        
    - name: üíæ Restaurar Cach√© de Vendor
      id: cache-vendor # ID para usar en condicionales
      uses: actions/cache@v4
      with:
        # La clave cambia si composer.lock cambia, forzando un 'cache miss'
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        path: vendor # Cachea la carpeta 'vendor'
        
    - name: ‚¨áÔ∏è Instalar Dependencias de Composer (Solo si hay Cache Miss)
      # Solo se ejecuta si el cach√© NO fue exitoso (es decir, composer.lock cambi√≥)
      if: steps.cache-vendor.outputs.cache-hit != 'true'
      run: composer install --prefer-dist --no-dev --optimize-autoloader
      env:
        COMPOSER_NO_INTERACTION: 1
        COMPOSER_NO_AUDIT: 1
        COMPOSER_PROCESS_TIMEOUT: 0 
      
    - name: Copiar .env de Producci√≥n
      run: echo "${{ secrets.ENV_FILE }}" > .env
      
    - name: Optimizar Configuraci√≥n y Rutas
      run: |
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache 
        
    - name: üì¶ Empaquetar Vendor.zip (Solo si hay nuevo Vendor)
      id: create-zip
      # Solo se ejecuta si el cach√© fall√≥ (cache-miss) y se gener√≥ un nuevo vendor
      if: steps.cache-vendor.outputs.cache-hit != 'true'
      run: |
        echo "Comprimiendo la nueva carpeta 'vendor' en vendor.zip..."
        zip -r vendor.zip vendor/
        
    # -----------------------------------------------
    # 2. PREPARACI√ìN DEL FRONTEND
    # -----------------------------------------------
    - name: Instalar Dependencias de NPM
      run: npm install

    - name: Compilar Assets con Vite (Producci√≥n)
      run: npm run build
      
    # -----------------------------------------------
    # 2.1 Limpieza Final del Workspace
    # -----------------------------------------------
    - name: üóëÔ∏è Limpiar Workspace antes de FTP
      run: |
        echo "Eliminando node_modules, tests, y carpeta vendor para subir solo el ZIP..."
        rm -rf node_modules 
        rm -rf tests 
        rm -rf vendor # Eliminamos la carpeta vendor ya que su contenido est√° en vendor.zip
        rm -rf storage/framework/cache/data # Cache generada en CI
        
    # -----------------------------------------------
    # 3. DESPLIEGUE FINAL (FTP)
    # -----------------------------------------------
    - name: DEPLOY POR FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        server-dir: /
        exclude: |
          public/
          .git* 
          .github 
          .env* 
          .env

          # Archivos persistentes del servidor (PROTEGER DE BORRADO)
          storage/logs/
          storage/app/public/ 
          storage/framework/sessions/*
          storage/framework/cache/data/*
          bootstrap/cache/services.php
          bootstrap/cache/*    
  
          
          # Redundancia: Estos ya se borraron arriba, pero es buena pr√°ctica
          node_modules
          tests
          vendor

    - name: Deploy FRONTEND
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        # El destino es la subcarpeta que el mundo ve
        local-dir: public/
        server-dir: /public_html/
        
       
    # -----------------------------------------------
      # 5. CONFIGURACI√ìN FINAL DEL SERVIDOR (SSH)
      # -----------------------------------------------
    - name: SSH V√≠nculo, Descompresi√≥n y Limpieza Final
      uses: appleboy/ssh-action@v1.0.3 
      with:
        host: ${{ secrets.FTP_HOST }} 
        username: ${{ secrets.FTP_USERNAME }}
        port: 65002
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        
        script: |
          echo "Navegando a la ra√≠z del proyecto"
          cd "/"
          
          # 1. DESCOMPRESI√ìN DE VENDOR.ZIP (si existe)
          if [ -f vendor.zip ]; then
            echo "vendor.zip encontrado. Descomprimiendo..."
            unzip -o vendor.zip -d . 
            rm vendor.zip
            echo "vendor.zip descomprimido y eliminado."
          else
            echo "vendor.zip no encontrado. Saltando descompresi√≥n."
          fi
          
          # 2. CREACI√ìN/VERIFICACI√ìN DEL V√çNCULO SIMB√ìLICO (storage:link)
          echo "Creando/verificando v√≠nculo simb√≥lico (storage:link)..."
          rm -f public_html/storage 
          php artisan storage:link 
          
          # 3. LIMPIEZA TOTAL DE CACH√â (CRUCIAL despu√©s de un deploy)
          echo "Realizando limpieza total de cach√© de Laravel..."
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan optimize:clear
          
          echo "Tareas post-deploy completadas con √©xito."