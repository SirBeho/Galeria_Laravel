name: Deploy Produccion Optimizada

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout CÃ³digo Fuente
      uses: actions/checkout@v4

    # -----------------------------------------------
    # 1. PREPARACIÃ“N DEL BACKEND
    # -----------------------------------------------
    - name: Configurar PHP (8.2)
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # AsegÃºrate que esta es la versiÃ³n de tu hosting
        extensions: pdo_mysql, dom, curl, mbstring, zip
        tools: composer
        
    - name: Instalar Dependencias de Composer (Solo Prod)
      run: composer install --prefer-dist --no-dev --optimize-autoloader
      # ^ CLAVE: Ignora las dependencias de desarrollo (--no-dev) para un paquete mÃ¡s ligero.
      
    - name: Copiar .env de ProducciÃ³n
      # Se asume que has guardado el contenido de tu .env de producciÃ³n como un secreto
      run: echo "${{ secrets.ENV_FILE }}" > .env
      
    - name: Optimizar ConfiguraciÃ³n y Rutas
      run: |
        php artisan key:generate
        php artisan config:cache # Cachea la configuraciÃ³n para lectura mÃ¡s rÃ¡pida
        php artisan route:cache  # Cachea las rutas, esencial para velocidad
        
    # -----------------------------------------------
    # 2. PREPARACIÃ“N DEL FRONTEND
    # -----------------------------------------------
    - name: Instalar Dependencias de NPM
      run: npm install

    - name: Compilar Assets con Vite (ProducciÃ³n)
      run: npm run build

    - name: ğŸ—‘ï¸ Limpiar Workspace (Eliminar node_modules)  # <-- NUEVO PASO
      run: |
        echo "Eliminando node_modules y otros archivos grandes innecesarios..."
        rm -rf node_modules 
      
    # -----------------------------------------------
    # 3. DESPLIEGUE FINAL (FTP)
    # -----------------------------------------------
    - name: Deploy vÃ­a FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        # Excluye archivos que solo son necesarios en desarrollo o CI
        exclude: |
          # 1. ARCHIVOS DE GIT Y CI (No son cÃ³digo de la app)
          .git* # Metadatos del repositorio (no necesarios en producciÃ³n)
          .github           # El directorio de GitHub Actions
          
          # 2. DEPENDENCIAS DE DESARROLLO (Archivos grandes de la CI)
          node_modules      # Dependencias de JS (solo necesarias para la compilaciÃ³n)
          vendor            # Dependencias de PHP (si Composer no se instalÃ³ con --no-dev)
          tests             # Archivos de pruebas PHP (no necesarios en producciÃ³n)

          # 3. ARCHIVOS SENSIBLES (.env y logs)
          .env* # Excluye .env.example, .env.testing, etc.
          .env              # Â¡IMPORTANTE! Excluye el archivo .env que creamos en la CI.
          storage/logs/* # Logs que genera el servidor (no se deben sobreescribir)
          
          # 4. CACHÃ‰S RESIDUALES DE LA CI
          storage/framework/cache/data/*
          
          # 5. CARPETAS GRANDES DEL SERVIDOR (Las que quieres proteger de ser borradas)
          public/images     # â¬…ï¸ Tu carpeta de imÃ¡genes grandes
          storage/app/public/* # â¬…ï¸ Archivos subidos por usuarios (si usas storage:link)
          storage/framework/sessions/* # â¬…ï¸ Sesiones de usuario (para evitar conflictos)
          storage/framework/cache/data/*
    
    # -----------------------------------------------
    # 4. LIMPIEZA AUTOMÃTICA POST-DEPLOY (Nueva Etapa)
    # -----------------------------------------------
    - name: ğŸ§¹ Limpieza de CachÃ© del Servidor Remoto
    # AsegÃºrate de usar la APP_URL de tu .env (que debe ser https://xn--mundodelcumpleao-lub.com/)
      run: |
        DEPLOY_TOKEN="${{ secrets.DEPLOY_CLEAN_TOKEN }}"
        DEPLOY_URL="${{ secrets.FTP_HOST }}" # Usamos FTP_HOST o creamos un nuevo secreto APP_URL_PROD
        
        # Opcional: Reemplaza FTP_HOST con tu URL real si tienes un secreto para ella
        # En este ejemplo, asumiremos que tienes un secreto llamado APP_URL_PROD

        CLEAN_URL="https://${{ secrets.APP_URL_PROD }}/limpiar-deploy-secreto/${DEPLOY_TOKEN}"
        
        echo "Activando limpieza de cachÃ© en el servidor..."
        # El comando 'curl' realiza la solicitud HTTP a la ruta secreta
        curl -fsSL -X GET "$CLEAN_URL"
      env:
        # AsegÃºrate de definir el secreto APP_URL_PROD en GitHub
        APP_URL_PROD: xn--mundodelcumpleao-lub.com