name: üöÄ Deploy Producci√≥n Optimizada (Hostinger)

on:
  push:
    branches: [ "master" ] 

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    
    # Variables de entorno globales para el Job
    env:
      APP_URL_PROD: xn--mundodelcumpleao-lub.com
      DEPLOY_CLEAN_TOKEN: ${{ secrets.DEPLOY_CLEAN_TOKEN }}

    steps:
      # ======================================================
      # FASE 1: CONFIGURACI√ìN Y CONSTRUCCI√ìN (BUILD)
      # ======================================================
      
      - name: üì• 1. Descargar C√≥digo Fuente
        uses: actions/checkout@v4

      - name: üêò 2. Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_mysql, dom, curl, mbstring, zip
          tools: composer

      # --- Optimizaci√≥n de Cach√© para Composer ---
      - name: üíæ 3. Restaurar Cach√© de Vendor
        id: cache-vendor
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          path: vendor

      - name: ‚¨áÔ∏è 4. Instalar Dependencias Backend
        # Si no hubo cach√©, instalamos desde cero.
        # --no-dev: No instalamos librer√≠as de desarrollo para producci√≥n.
        if: steps.cache-vendor.outputs.cache-hit != 'true'
        run: composer install --prefer-dist --no-dev --optimize-autoloader
        env:
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: üìÑ 5. Generar archivo .env
        run: echo "${{ secrets.ENV_FILE }}" > .env


      - name: üì¶ 6. Crear Vendor.zip
        id: create-zip
        if: steps.cache-vendor.outputs.cache-hit != 'true'
        run: |
          echo "Comprimiendo vendor para acelerar subida FTP..."
          zip -r vendor.zip vendor/

      # --- Construcci√≥n del Frontend ---
      - name: üì¶ 7. Instalar Dependencias NPM
        run: npm ci # 'npm ci' es m√°s r√°pido y seguro que 'install' para entornos CI

      - name: üé® 8. Compilar Assets (Vite Build)
        run: npm run build

      # ======================================================
      # FASE 2: LIMPIEZA PRE-DESPLIEGUE
      # ======================================================
      
      - name: üßπ 9. Limpiar Workspace
        run: |
          echo "Eliminando archivos innecesarios para reducir tiempo de subida..."
          rm -rf node_modules 
          rm -rf tests 
          rm -rf vendor # Ya lo tenemos en vendor.zip
          rm -rf storage/framework/cache/data # Evitar subir cach√© local
          # Opcional: Eliminar archivos fuente de frontend si solo necesitas el build
          # rm -rf resources/js 

      # ======================================================
      # FASE 3: DESPLIEGUE (FTP)
      # ======================================================

      - name: üì§ 10. Subir Backend (Core de Laravel)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          server-dir: / # Sube a la ra√≠z del usuario (donde vive artisan)
          exclude: |
            public/ # ¬°IMPORTANTE! Excluimos public porque va a public_html
            .git*
            .github
            .env*
            node_modules
            tests
            vendor # Excluido porque subimos el .zip
            
            # Archivos que NO queremos sobrescribir en el servidor si ya existen:
            storage/logs/
            storage/app/public/
            storage/framework/sessions/*
            storage/framework/cache/data/*

      - name: üì§ 11. Subir Frontend (Archivos P√∫blicos)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          local-dir: public/      # Origen: Carpeta compilada local
          server-dir: /public_html/ # Destino: Carpeta p√∫blica del hosting
    
      # ======================================================
      # FASE 4: POST-DESPLIEGUE (SSH)
      # ======================================================
      - name: üîê 12. Tareas Finales por SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }} 
          username: ${{ secrets.SSH_USER }}
          port: 65002
          key: ${{ secrets.PRIVATE_KEY_SSH }}
          
          script: |
            # --- CONFIGURACI√ìN DE RUTAS ---
            # Definimos la ruta absoluta para evitar errores de navegaci√≥n
            PROJECT_ROOT="/home/${{ secrets.SSH_USER }}/domains/xn--mundodelcumpleao-lub.com"
            
            echo "üìç Navegando a la ra√≠z del proyecto: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || { echo "‚ùå ERROR FATAL: No se pudo entrar a la carpeta."; exit 1; }

            # --- 1. GESTI√ìN DE DEPENDENCIAS (VENDOR) ---
            if [ -f vendor.zip ]; then
              echo "üì¶ vendor.zip detectado. Descomprimiendo..."
              unzip -o vendor.zip -d . > /dev/null # > /dev/null silencia la salida masiva
              rm vendor.zip
              echo "‚úÖ Vendor actualizado y zip eliminado."
            else
              echo "‚ö†Ô∏è No se encontr√≥ vendor.zip. Omitiendo descompresi√≥n."
            fi

            # --- 2. ENLACE SIMB√ìLICO (STORAGE) ---
            echo "üîó Configurando Storage Link..."
            # Borramos el enlace existente en public_html para recrearlo limpio
            rm -f public_html/storage 
            php artisan storage:link

            # --- 3. LIMPIEZA Y OPTIMIZACI√ìN DE CACH√â ---
            echo "üßπ Ejecutando limpieza de cach√© de Laravel..."
            chmod -R 775 storage bootstrap/cache
            # Es vital ejecutar esto AQU√ç y no en el Build para que las rutas sean las del servidor
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            # Opcional: Solo optimizar en producci√≥n real
            php artisan optimize 
            
            echo "üöÄ ¬°Despliegue completado con √©xito!"