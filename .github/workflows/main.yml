name: Deploy Produccion Optimizada

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define la URL de producci√≥n como una variable de entorno para el Job
    env:
      APP_URL_PROD: xn--mundodelcumpleao-lub.com
      DEPLOY_CLEAN_TOKEN: ${{ secrets.DEPLOY_CLEAN_TOKEN }}

    steps:
    - name: Checkout C√≥digo Fuente
      uses: actions/checkout@v4

    # -----------------------------------------------
    # 1. PREPARACI√ìN DEL BACKEND (con Caching Condicional)
    # -----------------------------------------------
    - name: Configurar PHP (8.2)
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Aseg√∫rate que esta es la versi√≥n de tu hosting
        extensions: pdo_mysql, dom, curl, mbstring, zip # 'zip' es vital para el vendor.zip
        tools: composer
        
    - name: üíæ Restaurar Cach√© de Vendor
      id: cache-vendor # ID para usar en condicionales
      uses: actions/cache@v4
      with:
        # La clave cambia si composer.lock cambia, forzando un 'cache miss'
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        path: vendor # Cachea la carpeta 'vendor'
        
    - name: ‚¨áÔ∏è Instalar Dependencias de Composer (Solo si hay Cache Miss)
      # Solo se ejecuta si el cach√© NO fue exitoso (es decir, composer.lock cambi√≥)
      if: steps.cache-vendor.outputs.cache-hit != 'true'
      run: composer install --prefer-dist --no-dev --optimize-autoloader
      env:
        COMPOSER_NO_INTERACTION: 1
        COMPOSER_NO_AUDIT: 1
        COMPOSER_PROCESS_TIMEOUT: 0 
      
    - name: Copiar .env de Producci√≥n
      run: echo "${{ secrets.ENV_FILE }}" > .env
      
    - name: Optimizar Configuraci√≥n y Rutas
      run: |
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache 
        
    - name: üì¶ Empaquetar Vendor.zip (Solo si hay nuevo Vendor)
      id: create-zip
      # Solo se ejecuta si el cach√© fall√≥ (cache-miss) y se gener√≥ un nuevo vendor
      if: steps.cache-vendor.outputs.cache-hit != 'true'
      run: |
        echo "Comprimiendo la nueva carpeta 'vendor' en vendor.zip..."
        zip -r vendor.zip vendor/
        
    # -----------------------------------------------
    # 2. PREPARACI√ìN DEL FRONTEND
    # -----------------------------------------------
    - name: Instalar Dependencias de NPM
      run: npm install

    - name: Compilar Assets con Vite (Producci√≥n)
      run: npm run build
      
    # -----------------------------------------------
    # 2.1 Limpieza Final del Workspace
    # -----------------------------------------------
    - name: üóëÔ∏è Limpiar Workspace antes de FTP
      run: |
        echo "Eliminando node_modules, tests, y carpeta vendor para subir solo el ZIP..."
        rm -rf node_modules 
        rm -rf tests 
        rm -rf vendor # Eliminamos la carpeta vendor ya que su contenido est√° en vendor.zip
        rm -rf storage/framework/cache/data # Cache generada en CI
        
    # -----------------------------------------------
    # 3. DESPLIEGUE FINAL (FTP)
    # -----------------------------------------------
    - name: Deploy BACKEND
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        server-dir: /
        exclude: |
          public/
          .git* 
          .github 
          .env* 
          .env

          # Archivos persistentes del servidor (PROTEGER DE BORRADO)
          storage/logs/
          storage/app/public/ 
          public/images 
          storage/framework/sessions/*
          storage/framework/cache/data/*
          
          # Redundancia: Estos ya se borraron arriba, pero es buena pr√°ctica
          node_modules
          tests
          vendor

    - name: Deploy FRONTEND
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        # El destino es la subcarpeta que el mundo ve
        local-dir: public/ 
        server-dir: public_html/
        
        # Excluir archivos grandes o innecesarios en public_html
        exclude: |
          /images
      # -----------------------------------------------
    # 4. LIMPIEZA AUTOM√ÅTICA POST-DEPLOY (Descompresi√≥n Remota)
    # -----------------------------------------------
    - name: üßπ Descompresi√≥n y Limpieza de Cach√© del Servidor Remoto
      # Este paso se ejecuta despu√©s de que el FTP haya subido el c√≥digo y el vendor.zip (si aplica)
      run: |
        # Construye la URL usando la variable de entorno del Job
        CLEAN_URL="https://${{ env.APP_URL_PROD }}/limpiar-deploy-secreto/${{ env.DEPLOY_CLEAN_TOKEN }}"
        
        echo "Activando descompresi√≥n de vendor.zip y limpieza de cach√© en el servidor: $CLEAN_URL"
        # La opci√≥n -f failes silently on server errors (4xx/5xx)
        RESPONSE_BODY=$(cat response.txt)
        
        echo "C√≥digo de Estado HTTP: $HTTP_STATUS"
        echo "Cuerpo de la Respuesta (Error/√âxito):"
        echo "$RESPONSE_BODY"
        
        # Evaluamos el estado: 200 es √©xito. Cualquier otra cosa es un fallo.
        if [ "$HTTP_STATUS" -ne 200 ]; then
          echo "::error::La limpieza del servidor fall√≥. C√≥digo: $HTTP_STATUS. Mensaje: $RESPONSE_BODY"
          exit 1
        fi
        
      shell: /usr/bin/bash -e {0}