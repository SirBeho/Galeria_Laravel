name: ğŸš€ Deploy ProducciÃ³n Optimizada (Hostinger)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    # Variables de entorno globales para el Job
    env:
      APP_URL_PROD: xn--mundodelcumpleao-lub.com
      DEPLOY_CLEAN_TOKEN: ${{ secrets.DEPLOY_CLEAN_TOKEN }}

    steps:
      # ======================================================
      # FASE 1: CONFIGURACIÃ“N Y CONSTRUCCIÃ“N (BUILD)
      # ======================================================

      - name: ğŸ“¥ 1. Descargar CÃ³digo Fuente
        uses: actions/checkout@v4

      - name: ğŸ˜ 2. Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: pdo_mysql, dom, curl, mbstring, zip
          tools: composer

      # --- OptimizaciÃ³n de CachÃ© para Composer ---
      - name: ğŸ’¾ 3. Restaurar CachÃ© de Vendor
        id: cache-vendor
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          path: vendor

      - name: â¬‡ï¸ 4. Instalar Dependencias Backend (Dev + Prod)
        if: steps.cache-vendor.outputs.cache-hit != 'true'
        run: composer install --prefer-dist --optimize-autoloader
        env:
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: ğŸ“„ 5. Generar archivo .env y Key (CI)
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          php artisan key:generate

      # ğŸ“¦ 6. Instalar Dependencias Frontend (NPM ci)
      - name: ğŸ“¦ 6. Instalar Dependencias NPM (CI)
        run: npm ci

      # ğŸ¨ 7. Compilar Assets (Vite Build)
      - name: ğŸ¨ 7. Compilar Assets (Vite Build)
        run: npm run build

      # ======================================================
      # FASE 2: QUALITY GATES (PRUEBAS UNIFICADAS)
      # ======================================================

      - name: ğŸ§ª 8. Ejecutar Pruebas PHPUnit (Backend Quality Gate)
        run: |
          # Crea el archivo testing.sqlite si no existe.
          touch database/testing.sqlite
          # ğŸ›‘ Usamos el .env de PRUEBAS para aislar los datos.
          php artisan migrate:fresh --env=testing --force
          php artisan test --stop-on-failure

      # ğŸ’¥ NUEVO PASO: EJECUCIÃ“N DE PRUEBAS E2E (CYPRESS)
      - name: ğŸ’» 9. Ejecutar Pruebas Cypress E2E (Frontend Quality Gate)
        run: npm run test
        env:
          # ğŸ’¡ Aseguramos que la URL base de Cypress apunte al servidor de pruebas de Laravel
          APP_URL: http://localhost:8000

      - name: ğŸ§¹ 10. Limpiar Dependencias de Desarrollo
        run: composer install --prefer-dist --no-dev --optimize-autoloader

      # ğŸ“¦ 11. Crear Vendor.zip
      - name: ğŸ“¦ 11. Crear Vendor.zip
        id: create-zip
        if: steps.cache-vendor.outputs.cache-hit != 'true'
        run: |
          echo "Comprimiendo vendor para acelerar subida FTP..."
          zip -r vendor.zip vendor/

      # ======================================================
      # FASE 3: LIMPIEZA PRE-DESPLIEGUE Y DESPLIEGUE
      # ======================================================

      - name: ğŸ§¹ 12. Limpiar Workspace
        run: |
          echo "Eliminando archivos innecesarios para reducir tiempo de subida..."
          rm -rf node_modules 
          rm -rf tests 
          rm -rf vendor
          rm -rf storage/framework/cache/data 
          # rm -rf resources/js # Opcional si solo necesitas el build
          # rm -rf resources/js

      # ======================================================
      # FASE 3: DESPLIEGUE (FTP)
      # ======================================================

      - name: ğŸ“¤ 13. Subir Backend (Core de Laravel)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          server-dir: / # Sube a la raÃ­z del usuario (donde vive artisan)
          exclude: |
            public/ 
            .git*
            .github
            .env*
            node_modules
            tests
            vendor # Excluido porque subimos el .zip

            # Archivos que NO queremos sobrescribir en el servidor si ya existen:
            storage/logs/
            storage/app/public/
            storage/framework/sessions/*
            storage/framework/cache/data/*

      - name: ğŸ“¤ 14. Subir Frontend (Archivos PÃºblicos)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          local-dir: public/ # Origen: Carpeta compilada local
          server-dir: /public_html/ # Destino: Carpeta pÃºblica del hosting

      # ======================================================
      # FASE 4: POST-DESPLIEGUE (SSH)
      # ======================================================
      - name: ğŸ” 15. Tareas Finales por SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: 65002
          key: ${{ secrets.PRIVATE_KEY_SSH }}

          script: |
            # --- CONFIGURACIÃ“N DE RUTAS ---
            # Definimos la ruta absoluta para evitar errores de navegaciÃ³n
            PROJECT_ROOT="/home/${{ secrets.SSH_USER }}/domains/xn--mundodelcumpleao-lub.com"

            echo "ğŸ“ Navegando a la raÃ­z del proyecto: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || { echo "âŒ ERROR FATAL: No se pudo entrar a la carpeta."; exit 1; }

            # --- 1. GESTIÃ“N DE DEPENDENCIAS (VENDOR) ---
            if [ -f vendor.zip ]; then
              echo "ğŸ“¦ vendor.zip detectado. Descomprimiendo..."
              unzip -o vendor.zip -d . > /dev/null # > /dev/null silencia la salida masiva
              rm vendor.zip
              echo "âœ… Vendor actualizado y zip eliminado."
            else
              echo "âš ï¸ No se encontrÃ³ vendor.zip. Omitiendo descompresiÃ³n."
            fi

            # --- 2. ENLACE SIMBÃ“LICO (STORAGE) ---
            echo "ğŸ”— Configurando Storage Link..."
            # Borramos el enlace existente en public_html para recrearlo limpio
            rm -f public_html/storage 
            php artisan storage:link-html

            # --- 3. LIMPIEZA Y OPTIMIZACIÃ“N DE CACHÃ‰ ---
            echo "ğŸ§¹ Ejecutando limpieza de cachÃ© de Laravel..."
            chmod -R 775 storage bootstrap/cache
            # Es vital ejecutar esto AQUÃ y no en el Build para que las rutas sean las del servidor
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan optimize 

            echo "ğŸš€ Â¡Despliegue completado con Ã©xito!"
